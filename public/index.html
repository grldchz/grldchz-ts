<?php
if ( !file_exists( dirname(__FILE__).'/../grldservice' ) && !is_dir( dirname(__FILE__).'/../grldservice' ) ) {
	require_once(dirname(__FILE__).'/grldservice-dev/lib/Auth.php');
	require_once(dirname(__FILE__).'/grldservice-dev/lib/Media.php');
	require_once(dirname(__FILE__).'/grldservice-dev/lib/Posts.php');
}
else{
	require_once(dirname(__FILE__).'/../grldservice/lib/Auth.php');
	require_once(dirname(__FILE__).'/../grldservice/lib/Media.php');
	require_once(dirname(__FILE__).'/../grldservice/lib/Posts.php');
}
$auth = new Auth();
$grldservice = $auth->get_service_context();
$domain=$auth->get_domain()==false?"localhost":"www.".$auth->get_domain();
$protocol=$auth->get_secure()==1?"https://":"http://";
$ui_context=$auth->get_ui_context();
$home=$protocol.$domain.$ui_context."/index.php";
$title=$auth->get_title();
$description="Grilled Cheese of the Day is a free social network where you can post text, photos, and videos to share with friends and family.";
if(isset($_GET["contentid"]) && $_GET["contentid"] != null
		&& isset($_GET["mediaid"]) && $_GET["mediaid"] != null){ 
	$html.="<p><a href='".$home."'>Home</a> > ";
	$html.="<a href='".$home."?contentid=".$_GET["contentid"]."'>contentid=".$_GET["contentid"]."</a> > ";
	$html.="mediaid=".$_GET["mediaid"]."</p>";
	$media = new Media($auth, $_GET["contentid"], $_GET["mediaid"]);
	$media->getMedia();
	$mediaobj = json_decode($media->printOutput());
	if($mediaobj->{'results'}){
		foreach($mediaobj->{'results'} as $mediarec){
			$description=stripslashes(strip_tags($mediarec->{'title'}));
			$description=substr($description,0,300).((strlen($description)<300)?"":"...");
			$title=substr($description,0,60).((strlen($description)<60)?"":"...");
			if($mediarec->{"is_image"}){
				$slide = $grldservice."/getfile.php?media=media/".$mediarec->{"user_name"}."/".$mediarec->{"content_id"}."/img_slide_".$mediarec->{"file"}.".jpeg";
				$html.="<p><img src='".$slide."' alt='".$mediarec->{"file"}."' title='".$mediarec->{"title"}."'/></p>";
				$html.="<h2>".$mediarec->{"title"}."</h2>";
			}
			else{
				$mp4 = $grldservice."/getfile.php?media=media/".$mediarec->{"user_name"}."/".$mediarec->{"content_id"}."/proxy_mp4_".$mediarec->{"file"}.".mp4";
				$html.="<video controls=true style='width:100%;max-width:600px' title='".$mediarec->{"title"}."'><source src='".$mp4."' type='video/mp4' /></video>";
				$html.="<h2>".$mediarec->{"title"}."</h2>";
			}
		}
	}
	else{
		$html="Media Not Found";
	}
}
else if(isset($_GET["contentid"]) && $_GET["contentid"] != null){
	$html.="<p><a href='".$home."'>Home</a> > ";
	$html.="<a href='".$home."?contentid=".$_GET["contentid"]."'>contentid=".$_GET["contentid"]."</a></p>";
	$posts = new Posts($auth, $_GET["contentid"]);
	$posts->getPosts();
	$obj = json_decode($posts->printOutput());
	if($obj->{'results'}){
		foreach($obj->{'results'} as $rec){
			$html.=$rec->{'first_name'}." ".$rec->{'last_name'}." @ ".$rec->{'post_date_time'}."<h2>".$rec->{'comment'}."</h2>";
			$description=stripslashes(strip_tags($rec->{'comment'}));
			$description=substr($description,0,300).((strlen($description)<300)?"":"...");
			$title=substr($description,0,60).((strlen($description)<60)?"":"...");
			$media = new Media($auth, $_GET["contentid"]);
			$media->getMedia();
			$mediaobj = json_decode($media->printOutput());
			if($mediaobj->{'results'}){
				foreach($mediaobj->{'results'} as $mediarec){
					$html.="<p><a href='".$home."?contentid=".$mediarec->{"content_id"}."&mediaid=".$mediarec->{"id"}."'>".$mediarec->{"title"}."</a></p>";
				}
			}
			if($rec->{'replies'}){
				foreach($rec->{'replies'} as $reply){
					$html.=$reply->{'first_name'}." ".$reply->{'last_name'}." @ ".$reply->{'post_date_time'}."<h4>".$reply->{'comment'}."</h4>";
				}
			}
		}
	}
	else{
		$html="Content Not Found";
	}
}
else{
	$start=0;
	if(isset($_GET["start"]) && $_GET["start"] != null){
		$start=$_GET["start"];
	}
	$posts = new Posts($auth, $start."", "10");
	$posts->getPosts();
	$obj = json_decode($posts->printOutput());
	if($obj->{'results'}){
		foreach($obj->{'results'} as $rec){
			$html.="<a href='".$home."?contentid=".$rec->{"id"}."'>".$rec->{'first_name'}." ".$rec->{'last_name'}." @ ".$rec->{'post_date_time'}."</a><h2>".$rec->{'comment'}."</h2>";
			$description.=$rec->{'comment'}." ";
		}
		if(($start+10)<$obj->{'total'}){
			$html.="<a href='".$home."?start=".($start+10)."'>more</a>";
		}
		$description=strip_tags($description);
		$description=substr($description,0,300).((strlen($description)<300)?"":"...");
		$title=substr($description,0,60).((strlen($description)<60)?"":"...");
	}
	else{
		$html="No Results Found";
	}
}
?>
<!DOCTYPE html>
<!--
This is a part of the GRLDCHZ Social network

Copyright (C) 2022 grilledcheeseoftheday.com
-->
<html lang="en">
  <head>
    <title><?php print $title; ?></title>
	<meta name="description" content="<?php print $description; ?>" />
	<link rel="canonical" href="<?php echo $home; ?>" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8;FF=3;OtherUA=4"/>
    <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <link rel="icon" sizes="57x57" href="%PUBLIC_URL%/img/grldchz-icon-57.png" />
    <link rel="icon" sizes="72x72" href="%PUBLIC_URL%/img/grldchz-icon-72.png" />
    <link rel="icon" sizes="114x114" href="%PUBLIC_URL%/img/grldchz-icon-114.png" />
    <link rel="icon" sizes="144x144" href="%PUBLIC_URL%/img/grldchz-icon-144.png">
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="%PUBLIC_URL%/img/grldchz-icon-57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="%PUBLIC_URL%/img/grldchz-icon-72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="%PUBLIC_URL%/img/grldchz-icon-114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="%PUBLIC_URL%/img/grldchz-icon-144.png" />
  </head>
  <body>
    <div id="root"></div>
    <noscript>
	<h1><?php print $auth->get_title(); ?></h1>
	<?php print $html; ?>
	</noscript>
	<div id="copyright"><?php print $auth->get_title(); ?> &#169 2022</div>
  </body>
</html>
